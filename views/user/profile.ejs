<%- include('../layouts/userHeader.ejs') %>

<!-- breadcrumbs -->
<div class="breadcrumbs">
    <div class="container">
        <ol class="breadcrumb breadcrumb1 animated wow slideInLeft" data-wow-delay=".5s">
            <li><a href="/home"><span class="glyphicon glyphicon-home" aria-hidden="true"></span>Home</a></li>
            <li class="active">Profile Page</li>
        </ol>
    </div>
</div>
<!-- //breadcrumbs -->


    <div class="top-brands">
        <h2>Your Profile</h2>
        <div class="grid_3 grid_5">
            <div class="container rounded" style="background-color: white; margin-bottom: 30px;">
                <div class="row">
                    <div class="col-md-4 border-right">
                        <div class="card full_cardp user-card-full">
                            <div style="min-height: 310px;" class="row m-l-0 m-r-0">
                                <div class="card-block text-center text-white">
                                    <div class="d-flex flex-column align-items-center photo_name text-center p-3 py-5">
                                        <img class="rounded-circle rounded_photo mt-5" width="150"
                                            src="https://png.pngtree.com/png-vector/20191101/ourmid/pngtree-cartoon-color-simple-male-avatar-png-image_1934459.jpg"
                                            alt="User Photo">
                                    </div>
                                    <div>
                                        <span class="font-weight-bold user-name">
                                            <%= locals.user.name %>
                                        </span>
                                    </div>
                                </div>
                                <div class="prodetail">
                                    <ul class="profile">
                                        <li>
                                            <div class="wallet-dropdown">
                                                <a class="wdropdown-btn" href="/wallet?id=<%= locals.user.id %>">My
                                                    wallet</a>
                                            </div>
                                        </li>
                                        <li>
                                            <h4 class="user-wallet">â‚¹<%= locals.user.totalWallet %>
                                            </h4>
                                        </li>
                                        <li><a class="myord" href="/orders?id=<%= locals.user.id %>">MY ORDERS</a></li>
                                        <li>
                                            <div class="wallet-dropdown">
                                                <a style="color: red;" class="wdropdown-btn"
                                                    href="/wallet?id=<%= locals.user.id %>">
                                                    Delete Account</a>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div style="min-height: 310px;" class="card full_cardp user-card-full">
                            <div class="card-block text-center text-white">
                                <div class="row">
                                    <div class="col-md-7 border-right">
                                        <h3 style="margin-bottom: 15px; border-bottom: 2px solid gray;">User Information
                                        </h3>
                                        <div class="row my-3">
                                            <div class="col-sm-12 user-info">
                                                <h4 class="mb-3 font-weight-bold">Email</h4>
                                                <p class="text-muted">
                                                    <%= locals.user.email %>
                                                </p>
                                            </div>
                                            <div class="col-sm-12 user-info">
                                                <h4 class="mb-3 font-weight-bold">Phone</h4>
                                                <p class="text-muted">
                                                    <%= locals.user.mobile %>
                                                </p>
                                            </div>
                                        </div>
                                        <div class="row my-3">
                                            <div class="col-sm-12 user-info">
                                                <h4 style="margin-bottom: 10px;" class="mb-3 font-weight-bold">Address
                                                </h4>
                                                <button style="background-color: green; font-weight: 600; color: azure;"
                                                    id="profileAddAddressOpenButton" type="button"
                                                    class="btn btn-primary profileAddAddress-openButton">Add
                                                    New</button>
                                                <button
                                                    style="background-color: #808080;font-weight: 600; color: azure;"
                                                    type="button" class="btn btn-primary" data-toggle="modal"
                                                    data-target="#addressModal">
                                                    View
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-5">
                                        <h3 style="border-bottom: 2px solid gray; margin-bottom: 15px;">Update</h3>
                                        <div class="row">
                                            <div class="col-sm-12">
                                                <form action="/updateProfile" method="put">
                                                    <input value="<%= locals.user.name %>" name="profileName"
                                                        type="text" class="form-control mb-3 pupd" placeholder="Name">
                                                    <input value="<%= locals.user.email %>" name="profileEmail"
                                                        type="email" class="form-control mb-3 pupd" placeholder="Email">
                                                    <div style="display: flex;">
                                                        <input value="<%= locals.user.mobile %>" type="text"
                                                            class="form-control mb-3 pupd" name="profileMobile"
                                                            placeholder="Mobile">
                                                        <button id="profileUpdateSendOtpBtn"
                                                            style="padding: 1px 1px; background-color: #fe9126;"
                                                            class=" profilesndOtp btn btn-primary btn-block mb-3 pupd">Send
                                                            OTP</button>
                                                    </div>
                                                    <div style="display: flex;">
                                                        <input type="text" name="profileUpdateOtp"
                                                            class="form-control mb-3 pupd" placeholder="OTP">
                                                        <button id="profileUpdateVerifyOtpBtn" style="padding: 1px 1px;"
                                                            class=" profileverifyOtp btn btn-primary btn-block mb-3 pupd">Verify</button>
                                                    </div>
                                                    <h6 style="font-size: 14px;" class="pupd">Change Password? click =>
                                                        <i style="cursor: pointer;" class="fa-solid fa-unlock"></i>
                                                    </h6>
                                                    <button id="profileUpdateButton"
                                                        class="btn btn-success btn-block pupd">Update</button>
                                                    <span id="error-messagee"
                                                        style="color: red; display: grid; justify-content: center;"></span>
                                                    <span id="success-messagee"
                                                        style="color: green; display: grid; justify-content: center;"></span>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add New Address Modal -->
                    <div id="profileAddAddressModal" class="profileAddAddress-modal">
                        <div class="profileAddAddress-modal-content">
                            <span id="profileAddAddressCloseButton" class="profileAddAddress-closeButton">&times;</span>
                            <form action="" method="post" class="profileAddAddress-form">
                                <label for="name">Name:</label>
                                <input type="text" id="name" name="name" required>
                                <label for="mobile">Mobile:</label>
                                <input type="tel" id="mobile" name="mobile" required>
                                <label for="pincode">Pincode:</label>
                                <input type="text" id="pincode" name="pincode" required>
                                <label for="address">Address:</label>
                                <textarea id="address" name="address" required></textarea>
                                <label for="city">City:</label>
                                <input type="text" id="city" name="city" required>
                                <label for="state">State:</label>
                                <input type="text" id="state" name="state" required>
                                <div class="address-type">
                                    <label for="addressType">Address Type:</label>
                                    <select id="addressType" name="addressType" required>
                                        <option value="Home">Home</option>
                                        <option value="Work">Work</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <span id="profileAddAddressSuccessMessage"
                                    style="color: green; display: grid; justify-content: center;"></span>
                                <span id="profileAddAddressErrorMessage"
                                    style="color: red; display: grid; justify-content: center;"></span>
                                <div style="display: flex; justify-content: center;">
                                    <button id="profileAddAddressButton" type="submit">Add Address</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Password changing modal -->
                    <div class="profilemodal" id="changePasswordModal">
                        <div style="display: flex; flex-direction: column;" class="modal-content">
                            <span class="close-button">&times;</span>
                            <h3 class="ppupdate">Change Password</h3>
                            <input class="ppupdate" type="password" name="oldPassword" id="newPasswordInput"
                                placeholder="Old Password">
                            <input class="ppupdate" type="password" name="newPassword" id="confirmPasswordInput"
                                placeholder="New Password">
                            <button class="btn btn-success ppupdate" id="updatePasswordButton">Update</button>
                            <span id="error-message" style="color: red; display: grid; justify-content: center;"></span>
                            <span id="success-message"
                                style="color: green; display: grid; justify-content: center;"></span>
                        </div>
                    </div>

                    <!-- edit address -->
                    <% locals.user.address.forEach(function(address) { %>
                        <div id="editProfileAd<%=address._id %>" class="custom-modal" style="display: none">
                            <div class="custom-modal-content">
                                <b>
                                    <h1>Edit Address</h1>
                                </b>
                                <form id="editProfileAddressForm_<%=address._id %>" action="" method="patch">
                                    <input type="text" placeholder="Name" value="<%=address.name %>" name="proName"
                                        required><br>
                                    <input type="text" placeholder="Mobile" value="<%=address.mobile %>"
                                        name="proMobile" required><br>
                                    <input type="text" placeholder="Pincode" value="<%=address.pincode %>"
                                        name="proPincode" required><br>
                                    <input type="text" placeholder="Address" value="<%=address.address %>"
                                        name="proAddress" required><br>
                                    <input type="text" placeholder="City/District/Town" value="<%=address.city %>"
                                        name="proCity" required><br>
                                    <input type="text" placeholder="State" value="<%=address.state %>" name="proState"
                                        required><br>
                                    <div class="address-type">
                                        <select name="proAddressType">
                                            <option value="" disabled>Select an address type</option>
                                            <option value="Home" <% if (address.addressType==='Home' ) { %>selected<% }
                                                    %>>Home</option>
                                            <option value="Office" <% if (address.addressType==='Office' ) { %>selected
                                                <% } %>>Office
                                            </option>
                                        </select>
                                    </div>

                                    <button id="editProfileAddressBtn-<%=address._id %>" type="submit">Edit</button>
                                    <!-- Add Cancel button to close the Edit Address Modal -->
                                    <button type="button" class="cancel-button"
                                        onclick="hideEditModal('<%=address._id %>')">Cancel</button>
                                    <div style="margin-top: 10px;">
                                        <span id="profileEditAddressErrorMessage_<%=address._id %>"
                                            style="color: red;"></span>
                                        <span id="profileEditAddressSuccessMessage_<%=address._id %>"
                                            style="color: green;"></span>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <% }) %>

                            <!-- CONFIRMATION MODAL -->
                            <div id="confirmationModal" class="modal">
                                <div class="modal-content">
                                    <h2>Confirmation</h2>
                                    <p>Are you sure you want to delete this Address?</p>
                                    <div class="button-container">
                                        <button onclick="handleYesClicking()" class="yes-button">Yes</button>
                                        <button onclick="handleNoClicking()" class="no-button">No</button>
                                    </div>
                                    <span class="close-button" onclick="handleNoClicking()">&times;</span>
                                </div>
                            </div>
                            <!-- END OF CONFIRMATION MODAL -->

                            <div class="container">
                                <!-- Address Modal -->
                                <div class="modal fade" id="addressModal">
                                    <div class="modal-dialog modal-lg">
                                        <div style="background-color: aliceblue; padding: 30px;"
                                            class="modal-content-address">

                                            <div class="modal-header">
                                                <h4 class="modal-title">Your Saved Addresses:</h4>
                                                <button type="button" class="close"
                                                    data-dismiss="modal">&times;</button>
                                            </div>
                                            <% if (locals.user.address[0]) { %>
                                                <% for (let i=0; i < locals.user.address.length; i +=3) { %>
                                                    <div style="margin-top: 20px;" class="row">
                                                        <% for (let j=i; j < i + 3 && j < locals.user.address.length;
                                                            j++) { %>
                                                            <div class="col-md-4">
                                                                <div class="card address-item">
                                                                    <div style="min-height: 390px;" class="card-body">
                                                                        <h5 class="card-title">Fullname: <span>
                                                                                <%= locals.user.address[j].name %>
                                                                            </span></h5>
                                                                        <p class="card-text">Phone: <span>
                                                                                <%= locals.user.address[j].mobile %>
                                                                            </span></p>
                                                                        <p class="card-text">Address: <span>
                                                                                <%= locals.user.address[j].address %>
                                                                            </span></p>
                                                                        <p class="card-text">Pincode: <span>
                                                                                <%= locals.user.address[j].pincode %>
                                                                            </span></p>
                                                                        <p class="card-text">City: <span>
                                                                                <%= locals.user.address[j].city %>
                                                                            </span></p>
                                                                        <p class="card-text">State: <span>
                                                                                <%= locals.user.address[j].state %>
                                                                            </span></p>
                                                                        <p class="card-text">Address Type: <span>
                                                                                <%= locals.user.address[j].addressType
                                                                                    %>
                                                                            </span></p>
                                                                        <div class="action-buttons">

                                                                            <i style="cursor: pointer;color: #22c502;"
                                                                                id="edit_<%= locals.user.address[j]._id %>"
                                                                                type="button"
                                                                                class="fa-solid fa-user-pen fa-xl"
                                                                                data-toggle="modal"
                                                                                data-target="#editProfileAd<%= locals.user.address[j]._id %>"
                                                                                data-address-id="<%= locals.user.address[j]._id %>"
                                                                                data-dismiss="modal"></i>

                                                                            <a href="#"
                                                                                onclick="handleDeleteClicking(event, '<%= locals.user.address[j]._id %>')">
                                                                                <i class="fa-sharp fa-solid fa-trash fa-xl dicon"
                                                                                    data-toggle="modal"
                                                                                    data-target="#confirmationModal"
                                                                                    style="color: #e51b18;"
                                                                                    data-dismiss="modal"></i>
                                                                            </a>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <% } %>
                                                    </div>

                                                    <% } %>
                                                        <% } else { %>
                                                            <h3 style="text-align: center; color: red;">No Saved
                                                                Address
                                                            </h3>
                                                            <img src="../images/no_address_found-transformed.jpeg"
                                                                style="width: 440px;" alt="">
                                                            <% } %>

                                        </div>
                                    </div>
                                </div>
                            </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        // Function to show the profile modal
        function showProfileModal() {
            document.getElementById("changePasswordModal").style.display = "block";
        }

        // Function to hide the profile modal
        function hideProfileModal() {
            document.getElementById("changePasswordModal").style.display = "none";
        }

        // Add click event listener to the unlock icon
        const unlockIcon = document.querySelector(".fa-unlock");
        unlockIcon.addEventListener("click", showProfileModal);

        // Add click event listener to the close button
        const closeButton = document.querySelector(".close-button");
        closeButton.addEventListener("click", hideProfileModal);
    </script>


    <!-- SEND OTP  -->
    <script>
        document.getElementById('profileUpdateSendOtpBtn').addEventListener('click', async () => {
            event.preventDefault(); // Prevent form submission
            const mobile = document.querySelector('input[name="profileMobile"]').value;
            try {
                const response = await fetch('/sendOTP', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ mobile })
                });
                const data = await response.json();
                if (response.ok) {
                    // Handle successful response
                    var button = document.querySelector('button.profilesndOtp#profileUpdateSendOtpBtn');
                    button.disabled = true;
                    button.innerHTML = 'Resend';
                    button.style.backgroundColor = 'green';
                    button.style.color = 'white';
                    // Start the 15-second timer
                    var timeLeft = 15;
                    updateTimer();

                    var timer = setInterval(function () {
                        timeLeft--;
                        updateTimer();

                        if (timeLeft === 0) {
                            clearInterval(timer);
                            button.innerHTML = 'Resend OTP';
                            button.disabled = false;
                        }
                    }, 1000);

                    function updateTimer() {
                        var formattedTime = timeLeft < 10 ? '0' + timeLeft : timeLeft;
                        button.innerHTML = 'Resend (' + formattedTime + 's)';
                    }
                    document.getElementById('success-messagee').textContent = data.message;
                    setTimeout(function () {
                        document.getElementById('success-messagee').textContent = '';
                    }, 3000);
                } else {
                    // Handle error response
                    document.getElementById('error-messagee').textContent = data.message;
                    setTimeout(function () {
                        document.getElementById('error-messagee').textContent = '';
                    }, 3000);
                }
            } catch (error) {
                console.log('An error occurred:', error.message);
            }
        });
    </script>

    <!-- VERIFY OTP -->
    <script>
        document.getElementById('profileUpdateVerifyOtpBtn').addEventListener('click', async () => {
            event.preventDefault(); // Prevent form submission
            const otp = document.querySelector('input[name="profileUpdateOtp"]').value;

            try {
                const response = await fetch('/verifyOTP', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ otp })
                });

                const data = await response.json();

                if (response.ok) {
                    // Handle successful response
                    var otpbutton = document.querySelector('button.profilesndOtp#profileUpdateSendOtpBtn');
                    otpbutton.style.display = 'none';

                    var button = document.querySelector('button.profileverifyOtp#profileUpdateVerifyOtpBtn');
                    button.disabled = true;
                    button.innerHTML = 'Verified';
                    button.style.backgroundColor = 'green';
                    button.style.color = 'white';


                    document.getElementById('success-messagee').textContent = data.message;
                    setTimeout(function () {
                        document.getElementById('success-messagee').textContent = '';
                    }, 3000);
                } else {
                    // Handle error response
                    document.getElementById('error-messagee').textContent = data.message;
                    setTimeout(function () {
                        document.getElementById('error-messagee').textContent = '';
                    }, 3000);
                }
            } catch (error) {
                console.log('An error occurred:', error.message);
            }
        });
    </script>

    <!-- Profile password change -->
    <script>
        document.getElementById('updatePasswordButton').addEventListener('click', async () => {
            event.preventDefault(); // Prevent form submission
            const oldPassword = document.querySelector('input[name="oldPassword"]').value;
            const newPassword = document.querySelector('input[name="newPassword"]').value;

            try {
                const response = await fetch('/profilePassword', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ oldPassword, newPassword })
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('success-message').textContent = data.message;
                    setTimeout(function () {
                        document.getElementById('success-message').textContent = '';
                    }, 3000);
                } else {
                    // Handle error response
                    document.getElementById('error-message').textContent = data.message;
                    setTimeout(function () {
                        document.getElementById('error-message').textContent = '';
                    }, 3000);
                }
            } catch (error) {
                console.log('An error occurred:', error.message);
            }
        });
    </script>

    <!-- update profile data -->
    <script>
        document.getElementById('profileUpdateButton').addEventListener('click', async () => {
            event.preventDefault(); // Prevent form submission
            const name = document.querySelector('input[name="profileName"]').value;
            const email = document.querySelector('input[name="profileEmail"]').value;
            const mobile = document.querySelector('input[name="profileMobile"]').value;

            try {
                const response = await fetch('/updateProfile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, email, mobile })
                });

                const data = await response.json();

                if (response.ok) {

                    // Handle successful response
                    document.getElementById('success-messagee').textContent = data.message;
                    setTimeout(function () {
                        document.getElementById('success-messagee').textContent = '';
                    }, 3000);

                } else {
                    // Handle error response
                    document.getElementById('error-messagee').textContent = data.message;
                    setTimeout(function () {
                        document.getElementById('error-messagee').textContent = '';
                    }, 3000);
                }
            } catch (error) {
                console.log('An error occurred:', error.message);
            }
        });
    </script>

    <!-- open and close address modal -->
    <script>
        var profileAddAddressModal = document.getElementById("profileAddAddressModal");
        var profileAddAddressOpenButton = document.getElementById("profileAddAddressOpenButton");
        var profileAddAddressCloseButton = document.getElementById("profileAddAddressCloseButton");

        profileAddAddressOpenButton.addEventListener("click", function () {
            profileAddAddressModal.style.display = "block";
        });

        profileAddAddressCloseButton.addEventListener("click", function () {
            profileAddAddressModal.style.display = "none";
        });

        window.addEventListener("click", function (event) {
            if (event.target == profileAddAddressModal) {
                profileAddAddressModal.style.display = "none";
            }
        });
    </script>

    <!-- add address -->
    <script>
        document.getElementById('profileAddAddressButton').addEventListener('click', async () => {
            event.preventDefault(); // Prevent form submission
            const name = document.querySelector('input[name="name"]').value;
            const mobile = document.querySelector('input[name="mobile"]').value;
            const pincode = document.querySelector('input[name="pincode"]').value;
            const address = document.querySelector('textarea[name="address"]').value;
            const city = document.querySelector('input[name="city"]').value;
            const state = document.querySelector('input[name="state"]').value;
            const addressType = document.querySelector('div.address-type select[name="addressType"]').value;

            try {
                const response = await fetch('/addAddress', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, mobile, pincode, address, city, state, addressType })
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('profileAddAddressSuccessMessage').textContent = data.message;
                    setTimeout(function () {
                        window.location.reload()
                    }, 2000);
                } else {
                    // Handle error response
                    document.getElementById('profileAddAddressErrorMessage').textContent = data.message;
                    setTimeout(function () {
                        document.getElementById('profileAddAddressErrorMessage').textContent = '';
                    }, 3000);
                }
            } catch (error) {
                console.log('An error occurred:', error.message);
            }
        });
    </script>

    <% locals.user.address.forEach(function(address) { %>
        <script>
            (function () {
                const addressId = '<%=address._id %>';
                const successMessageId = 'profileEditAddressSuccessMessage_' + addressId;
                const errorMessageId = 'profileEditAddressErrorMessage_' + addressId;

                document.getElementById('editProfileAddressBtn-' + addressId).addEventListener('click', async (event) => {
                    event.preventDefault();

                    const form = document.getElementById('editProfileAddressForm_' + addressId);

                    const name = form.querySelector('input[name="proName"]').value;
                    const mobile = form.querySelector('input[name="proMobile"]').value;
                    const pincode = form.querySelector('input[name="proPincode"]').value;
                    const address = form.querySelector('input[name="proAddress"]').value;
                    const city = form.querySelector('input[name="proCity"]').value;
                    const state = form.querySelector('input[name="proState"]').value;
                    const addressType = form.querySelector('div.address-type select[name="proAddressType"]').value;

                    try {
                        const response = await fetch('/editProfileAddress/' + addressId, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ name, mobile, pincode, address, city, state, addressType })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            document.getElementById(successMessageId).textContent = data.message;
                            setTimeout(function () {
                                window.location.reload()
                            }, 3000);
                        } else {
                            document.getElementById(errorMessageId).textContent = data.message;
                            setTimeout(function () {
                                document.getElementById(errorMessageId).textContent = '';
                            }, 3000);
                        }
                    } catch (error) {
                        console.log('An error occurred:', error.message);
                    }
                });
            })();
        </script>
        <% }) %>


            <script>
                function handleDeleteClicking(event, addressId) {
                    event.preventDefault();
                    showModal(addressId);
                }

                function showModal(addressId) {
                    const modal_con = document.getElementById("confirmationModal");
                    modal_con.style.display = "block";
                    modal_con.setAttribute("data-addressId", addressId);
                }

                function handleYesClicking() {
                    const modal_con = document.getElementById("confirmationModal");
                    const addressId = modal_con.getAttribute("data-addressId");

                    fetch(`/deleteProfileAddress/${addressId}`, {
                        method: "DELETE",
                    })
                        .then((response) => {
                            if (response.ok) {
                                return response.json();
                            } else {
                                throw new Error("Address not found.");
                            }
                        })
                        .then((data) => {
                            window.location.reload();
                            modal_con.style.display = "none";
                        })
                        .catch((error) => {
                            console.error(error);
                            alert("An error occurred while deleting the address.");
                        })
                        .finally(() => {
                            modal_con.style.display = "none";
                        });
                }

                function handleNoClicking() {
                    const modal_con = document.getElementById("confirmationModal");
                    modal_con.style.display = "none";
                }
            </script>



            <script>
                function hideEditModal(addressId) {
                    document.getElementById('editProfileAd' + addressId).style.display = 'none';
                }
            </script>

            <%- include('../layouts/userFooter.ejs') %>